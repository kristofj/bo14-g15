<!DOCTYPE html>
<html>
<head>
    <script src="jquery-2.1.0.min.js" ></script>
    <script src="jsapi.js"></script>
    <script>
        //bruker ajax i jQuery for å parse JSON fra .php-backend (dbToJson.php) basert på brukervalg
        function getWeatherJson() {
            $.ajax({
                url: 'dbToJson.php?type=' + $('input[name=type]:checked').val(),
                type: "post",
                dataType: "json",
                //fyrer callback-funksjon for å behandle data. kunne evt. vært gjort utenfor dette scope
                success: function (response) {
                    var radioSelected = ($('input[name=type]:checked').val());
                    if (radioSelected == "temp") {
                        var typeData = "Temperatur";
                        var mTypeData = "&deg;";
                    }
                    else if (radioSelected == "humidity") {
                        var typeData = "Luftfuktighet";
                        var mTypeData = "&#37;";
                    }
                    else if (radioSelected == "pressure") {
                        var typeData = "Lufttrykk";
                        var mTypeData = "something?";
                    }
                    else if (radioSelected == "wind") {
                        var typeData = "Vindhastighet";
                        var mTypeData = "m/s";
                        var dirMax = [];
                    }

                    var tabEntry = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
                    var time = [];
                    var fullTime = [];
                    var station = [];
                    var valAvg = [];
                    var valMin = [];
                    var timeMin = [];
                    var valMax = [];
                    var timeMax = [];
                    $.each(response, function (i, item) {
                        valAvg.push(item.valueAvg);
                        valMin.push(item.valueMin);
                        valMax.push(item.valueMax);
                        station.push(item.station);
                        if (radioSelected == "wind") {
                            dirMax.push(item.dirMax);
                        }
                        var fs = item.time.split(" ");
                        var ss = fs[0].split("-");
                        var ts = fs[1].split(":");
                        var d = new Date(ss[0], ss[1], ss[2], ts[0], ts[1]);
                        time.push(d.getDate() + '/' + d.getMonth() + ' ' + d.getHours() + ':' + d.getMinutes());
                        fullTime.push(d.getDate() + '/' + d.getMonth() + '/' + d.getYear() + ' ' + d.getHours() + ':' + d.getMinutes());
                        var fs = item.timeMin.split(" ");
                        var ss = fs[0].split("-");
                        var ts = fs[1].split(":");
                        var d = new Date(ss[0], ss[1], ss[2], ts[0], ts[1]);
                        timeMin.push(d.getHours() + ':' + d.getMinutes());
                        var fs = item.timeMax.split(" ");
                        var ss = fs[0].split("-");
                        var ts = fs[1].split(":");
                        var d = new Date(ss[0], ss[1], ss[2], ts[0], ts[1]);
                        timeMax.push(d.getHours() + ':' + d.getMinutes());
                    });
                    var data = new google.visualization.DataTable();
                    data.addColumn('string', 'time');
                    data.addColumn('number', typeData);
                    data.addColumn({type: 'string', role: 'tooltip', 'p': {'html': true}});

                    for (i = 0; i < time.length; i++) {
                        if (radioSelected == "wind") {
                            var windDirMax = "<br/>" + tabEntry + tabEntry + "Retning: " + dirMax[i];
                        }
                        else {
                            var windDirMax = "";
                        }
                        data.addRow([time[i], parseFloat(valAvg[i]), "<b>Stasjon " + station[i] + "</b><br/>" + fullTime[i] + "<br/>" + typeData + "<br/>" + tabEntry + "Gjennomsnitt: " + valAvg[i] + mTypeData + "<br/>" + tabEntry + "Maks: " + valMax[i] + mTypeData + " kl " + timeMax[i] + windDirMax + "<br/>" + tabEntry + "Minimum: " + valMin[i] + mTypeData + " kl " + timeMin[i]]);
                    }
                    //starter funksjon som tegner grafer basert på data bygd ovenfor
                    drawChart(data);
                }
            });
        }

        //fyller globalt deklarerte variabler
        function genChart(){
            button = document.getElementById('b1');
            chart = new google.visualization.LineChart(document.getElementById('chart_div'));
            options = {
                title: 'Trenger dynamisk tittel',
                curveType: 'function',
                animation: {
                    duration: 1000,
                    easing: 'in'
                },
                tooltip: { isHtml: true }
            };
            //starter JSON-laster for å fylle en graf basert på standardverdier i forms
            getWeatherJson();
        }

        //tegner opp grafer. blir kalt opp med dataobjekt fra JSON-laster.
        function drawChart(data) {
            chart.draw(data, options);
        }

        //deklarer variabler globalt for å ikke måtte generere de på nytt. Dette fører til mulgiheten for å animerte grafer med async ajax.
        var button;
        var chart;
        var options;

        //laster inn grafobjekter asynkront. kjører deretter genChart for å sette opp grafobjektene
        google.load("visualization", "1", {packages: ["corechart"]});
        google.setOnLoadCallback(genChart);
    </script>
</head>
<body>
<div id="chart_div" style="width: 900px; height: 500px;"></div>
<form action="">
    <input checked type="radio" name="type" value="temp">Temperatur<br/>
    <input type="radio" name="type" value="humidity">Luftfuktighet<br/>
    <input type="radio" name="type" value="pressure">Lufttrykk<br/>
    <input type="radio" name="type" value="wind">Vind
</form>
<button onclick="getWeatherJson()" id="b1">Click me</button>

</body>
</html>